name: monitoring

services:
  dozzle:
    image: docker.io/amir20/dozzle:v9.0.2@sha256:bad5ccd44a1bf40492e1142e9ae6fca2c53d197a01fee5ef5d0f6ed45ea21fcb
    container_name: dozzle
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      traefik:
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.dozzle.rule=Host(`dozzle.${DOMAIN}`)
      - traefik.http.routers.dozzle.entrypoints=websecure
      - traefik.http.routers.dozzle.middlewares=authelia@docker
      - traefik.http.routers.dozzle.service=dozzle
      - traefik.http.services.dozzle.loadbalancer.server.port=8080
    security_opt:
      - no-new-privileges:true

  fluentbit:
    image: docker.io/fluent/fluent-bit:4.2.2@sha256:7d727245767ae632eb296c2ff4d206bf2e205b5f244c1f37b8fdd61f9fb33985
    container_name: fluentbit
    volumes:
      - ./config/fluentbit/config.yaml:/fluent-bit/etc/fluent-bit.yaml:ro
      - ${APPS_FOLDER}/monitoring/fluentbit:/fluent-bit/etc/data:ro
      # Logs
      - ${APPS_FOLDER}/network/traefik/logs:/var/log/traefik:ro
    networks:
      metrics_internal:
    command:
      ["/fluent-bit/bin/fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.yaml"]
    restart: unless-stopped
    user: 568:568
    security_opt:
      - no-new-privileges:true

  homepage:
    image: ghcr.io/gethomepage/homepage:v1.9.0@sha256:7fa7b07a26bd8d90a44bb975c6455b10d8dee467ce674b040750ffb4a0f486d6
    container_name: homepage
    volumes:
      - ./config/homepage/widgets.yaml:/app/config/widgets.yaml
      - ./config/homepage/services.yaml:/app/config/services.yaml
      - ./config/homepage/settings.yaml:/app/config/settings.yaml
      - ./config/homepage/bookmarks.yaml:/app/config/bookmarks.yaml
    environment:
      PUID: 568
      PGID: 568
      TZ: Europe/Berlin
      HOMEPAGE_ALLOWED_HOSTS: homepage.${DOMAIN}
      HOMEPAGE_VAR_DOMAIN: ${DOMAIN}
    env_file:
      - homepage.env
    networks:
      traefik:
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.homepage.rule=Host(`homepage.${DOMAIN}`)
      - traefik.http.routers.homepage.entrypoints=websecure
      - traefik.http.routers.homepage.middlewares=authelia@docker
      - traefik.http.routers.homepage.service=homepage
      - traefik.http.services.homepage.loadbalancer.server.port=3000
    security_opt:
      - no-new-privileges:true

  scrutiny:
    image: ghcr.io/analogj/scrutiny:master-omnibus@sha256:e5638d8580adba40f7c03464cde8420866188b9e48cddb9fc3866ec3243163d5
    container_name: scrutiny
    volumes:
      - /run/udev:/run/udev:ro
      - ${APPS_FOLDER}/monitoring/scrutiny/config:/opt/scrutiny/config
      - ${APPS_FOLDER}/monitoring/scrutiny/data:/opt/scrutiny/influxdb
    networks:
      traefik:
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.scrutiny.rule=Host(`scrutiny.${DOMAIN}`)
      - traefik.http.routers.scrutiny.entrypoints=websecure
      - traefik.http.routers.scrutiny.middlewares=authelia@docker
      - traefik.http.routers.scrutiny.service=scrutiny
      - traefik.http.services.scrutiny.loadbalancer.server.port=8080
    cap_add:
      - SYS_RAWIO
      - SYS_ADMIN
    devices:
      - /dev/sda
      - /dev/sdb
      - /dev/sdc
      - /dev/sdd
      - /dev/sde
      - /dev/sdf
      - /dev/sdg
      - /dev/sdh
      - /dev/nvme0
    security_opt:
      - no-new-privileges:true

  victorialogs:
    image: docker.io/victoriametrics/victoria-logs:v1.43.1@sha256:3db89651b2ffa0f4fe5a0f8805ede409701f41ca63ebdd64cfa4a3cb63976b43
    container_name: victorialogs
    volumes:
      - ${APPS_FOLDER}/monitoring/victorialogs:/vlogs
    networks:
      metrics_internal:
      traefik:
    command: --storageDataPath=/vlogs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:9428/health"]
      interval: 1s
      timeout: 1s
      retries: 10
    labels:
      - traefik.enable=true
      - traefik.http.routers.victorialogs.rule=Host(`victorialogs.${DOMAIN}`)
      - traefik.http.routers.victorialogs.entrypoints=websecure
      - traefik.http.routers.victorialogs.middlewares=authelia@docker
      - traefik.http.routers.victorialogs.service=victorialogs
      - traefik.http.services.victorialogs.loadbalancer.server.port=9428
    user: 568:568
    security_opt:
      - no-new-privileges:true

  vmauth:
    image: docker.io/victoriametrics/vmauth:v1.134.0@sha256:15cdcbea7c2d3512f6288f35bb195527b290586ccd9c8415c32f1ef6993eed97
    container_name: vmauth
    depends_on:
      victorialogs:
        condition: service_healthy
    volumes:
      - ./config/vmauth:/etc/vmauth
    networks:
      metrics_internal:
    command: -auth.config=/etc/vmauth/vmauth.yaml
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8427/health"]
      interval: 1s
      timeout: 1s
      retries: 10
    user: 568:568
    security_opt:
      - no-new-privileges:true
networks:
  traefik:
    external: true
    name: traefik

  metrics_internal:
    external: false
    name: metrics_internal
    internal: true
